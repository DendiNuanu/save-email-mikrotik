<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="-1" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Free WiFi - Connect</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: url("https://images.lifestyleasia.com/wp-content/uploads/sites/7/2024/10/21143213/Untitled-design-69-1600x900.png") no-repeat center center;
      background-size: cover;
      position: relative;
    }
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      text-align: center;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 20px;
      border-radius: 10px;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 20px;
    }
    input {
      padding: 12px;
      border: none;
      border-radius: 6px;
      margin-bottom: 15px;
      width: 250px;
      font-size: 1rem;
    }
    .green-btn {
      background-color: #28a745;
      color: white;
      padding: 14px 28px;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .green-btn:hover {
      background-color: #218838;
    }
    .spinner {
      display: none;
      margin-top: 20px;
    }
    .spinner div {
      width: 18px;
      height: 18px;
      background-color: white;
      border-radius: 100%;
      display: inline-block;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .spinner div:nth-child(1) { animation-delay: -0.32s; }
    .spinner div:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome to Free WiFi</h1>
    <input type="email" id="email" placeholder="Enter your email" required>
    <br>
    <button id="connectBtn" class="green-btn">Connect</button>
    <div class="spinner" id="loadingSpinner"><div></div><div></div><div></div></div>
  </div>

  <script>
    // Tentukan endpoint login MikroTik
    function resolveLoginEndpoint() {
      const isPrivate =
        /^10\./.test(location.hostname) ||
        /^192\.168\./.test(location.hostname) ||
        /^172\.(1[6-9]|2\d|3[0-1])\./.test(location.hostname);
      return isPrivate ? (location.origin + "/login") : "http://login/login";
    }

    document.getElementById("connectBtn").addEventListener("click", function () {
      const email = document.getElementById("email").value.trim();
      if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
        alert("Please enter a valid email address.");
        return;
      }

      document.getElementById("connectBtn").style.display = "none";
      document.getElementById("loadingSpinner").style.display = "inline-block";

      // 1) Cek email di Railway
      fetch("https://save-email-mikrotik-production.up.railway.app/check_email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      })
      .then(r => r.json())
      .then(res => {
        if (res.status === "exists") return true;
        if (res.status === "not_found") {
          return fetch("https://save-email-mikrotik-production.up.railway.app/save_trial_email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
          }).then(() => true);
        }
        throw new Error(res.message || "Email check error");
      })
      .then(() => loginToWifi())
      .catch(err => {
        console.error(err);
        alert("Failed. Please try again.");
        resetForm();
      });
    });

    function loginToWifi() {
      const username = "user"; // Ganti sesuai hotspot user
      const password = "user"; // Ganti sesuai hotspot pass
      const dst = "https://nuanu.com/";
      const action = resolveLoginEndpoint();

      const form = document.createElement("form");
      form.method = "POST";
      form.action = action;
      form.style.display = "none";

      const u = document.createElement("input");
      u.name = "username"; u.value = username;
      const p = document.createElement("input");
      p.name = "password"; p.value = password;
      const d = document.createElement("input");
      d.name = "dst"; d.value = dst;

      form.appendChild(u);
      form.appendChild(p);
      form.appendChild(d);
      document.body.appendChild(form);

      setTimeout(() => form.submit(), 5000); // Delay 5 detik
    }

    function resetForm() {
      document.getElementById("connectBtn").style.display = "inline-block";
      document.getElementById("loadingSpinner").style.display = "none";
    }
  </script>
</body>
</html>
